<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Flow Learning æµå‹•å¼å­¸ç¿’å¹³å°</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* å…¨åŸŸè¨­å®šï¼šä½¿ç”¨ Segoe UI ç‡Ÿé€ ç¾ä»£æ„Ÿ */
*{box-sizing:border-box;font-family:'Segoe UI', 'Microsoft JhengHei', sans-serif;margin:0;padding:0}
body{background:#f0f2f5;color:#333; line-height: 1.6;}

/* é ‚éƒ¨ Header è¨­è¨ˆ */
header{background:#fff;padding:20px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.05); border-bottom: 3px solid #007bff;}
header h1{font-size:26px;margin-bottom:5px; color: #2c3e50; font-weight: 700;}
header p{color:#666; font-size: 14px; letter-spacing: 1px;}

/* å°è¦½åˆ— Nav è¨­è¨ˆ (Sticky) */
nav{background:#fff;padding:12px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.05); position:sticky; top:0; z-index:100;}
nav a{margin:0 15px;cursor:pointer;color:#555;text-decoration:none;font-weight:600; font-size: 15px; transition: color 0.3s;}
nav a:hover{color:#007bff}

/* é é¢å®¹å™¨ */
.page{display:none;max-width:800px;margin:25px auto;padding:0 20px;}

/* å¡ç‰‡è¨­è¨ˆ (Card UI) */
.card{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:20px; transition: transform 0.2s, box-shadow 0.2s;}
.card:hover{transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.08);}

/* æ–‡ç« åˆ—è¡¨æ¨£å¼ */
.article-item h3{color:#2c3e50;cursor:pointer; margin-bottom: 8px; font-size: 20px;}
.article-item h3:hover{color: #007bff;}
.article-desc {color:#666; font-size:14px; margin-bottom: 10px;}

/* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
input,textarea{width:100%;padding:12px;margin-top:10px;border-radius:8px;border:1px solid #ddd; font-size:16px; outline: none; transition: border 0.3s;}
input:focus{border-color: #007bff;}
button{width:100%; padding:12px;margin-top:10px;border-radius:8px; background:#007bff;color:#fff;border:none;cursor:pointer; font-weight:bold; font-size: 16px; transition: background 0.3s;}
button:hover{background:#0056b3}
button.secondary {background: #e9ecef; color: #495057;}
button.secondary:hover {background: #dee2e6;}
button.outline {background: transparent; border: 1px solid #007bff; color: #007bff;}
button.outline:hover {background: #f0f8ff;}

/* å„€è¡¨æ¿æ•¸æ“šæ ¼ */
.stat-grid {display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;}
.stat-box {background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #e9ecef;}
.stat-box h4 {font-size: 13px; color: #666; margin-bottom: 5px;}
.stat-box span {font-size: 24px; font-weight: bold; color: #007bff;}

/* å­¸ç¿’æª”æ¡ˆè¡¨æ ¼ */
.history-table {width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;}
.history-table th {text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: #666;}
.history-table td {padding: 10px; border-bottom: 1px solid #eee; color: #444;}
.history-table tr:last-child td {border-bottom: none;}

/* é€²åº¦æ¢ */
.progress-container {margin-bottom: 25px;}
.progress-bar {background: #e9ecef; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 8px;}
.progress-fill {background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: 0%; transition: width 1s ease-in-out;}

/* èŠå¤©èˆ‡ç•™è¨€å€åŸŸ */
#detailComments, #chatBox{height:350px;overflow-y:auto;border:1px solid #eee;padding:15px;border-radius:8px;background:#fafafa; margin-bottom: 10px;}
.chat-msg {margin-bottom: 12px; font-size: 15px;}
.chat-msg strong {color: #007bff; margin-right: 5px;}
.my-msg {text-align: right;}
.my-msg strong {color: #28a745;}
.comment {padding: 12px 0; border-bottom: 1px solid #eee;}

/* ä½¿ç”¨è€…ç‹€æ…‹ */
#userStatus {position: absolute; top: 25px; right: 25px; font-size: 14px; color: #888; font-weight: 500;}

/* RWD å¾®èª¿ */
@media (max-width: 600px) {
    #userStatus {display: none;} /* æ‰‹æ©Ÿç‰ˆéš±è—å³ä¸Šè§’ç‹€æ…‹ï¼Œé¿å…æ“‹ä½æ¨™é¡Œ */
    nav a {margin: 0 8px; font-size: 14px;}
    .stat-grid {grid-template-columns: 1fr;}
}

/* ç™»å…¥è¨»å†Šåˆ‡æ› */
.auth-toggle {text-align: center; margin-top: 15px; font-size: 14px;}
.auth-toggle span {color: #007bff; cursor: pointer; text-decoration: underline;}
</style>
</head>
<body>

<header>
  <h1>Flow Learning è—¥ç‰©å­¸ç¿’å¹³å°</h1>
  <p>æµå‹•å¼å­¸ç¿’ Ã— çŸ¥è­˜å…±äº« Ã— ç¤¾ç¾¤å…±å‰µ</p>
  <div id="userStatus"></div>
</header>

<nav>
  <a onclick="showPage('explore')">ğŸ“– èª²ç¨‹ç€è¦½</a>
  <a onclick="showPage('chatroom')">ğŸ’¬ ç¤¾ç¾¤èŠå¤©å®¤</a>
  <a onclick="showPage('account')">ğŸ“Š å€‹äººå„€è¡¨æ¿</a>
  <a onclick="showPage('login')">ğŸ‘¤ ç™»å…¥/è¨»å†Š</a>
</nav>

<!-- 1. ç™»å…¥/è¨»å†Šé  (Login/Register) -->
<div id="login" class="page" style="display:block;">
  <!-- ç™»å…¥è¡¨å–® -->
  <div id="loginForm" class="card" style="max-width:400px; margin: 40px auto;">
    <h2 style="text-align:center; margin-bottom:20px; color:#2c3e50;">æœƒå“¡ç™»å…¥</h2>
    <input id="loginUser" placeholder="è¼¸å…¥å¸³è™Ÿ">
    <input id="loginPass" type="password" placeholder="è¼¸å…¥å¯†ç¢¼">
    <button onclick="performLogin()">ç™»å…¥ç³»çµ±</button>
    <div class="auth-toggle">
        é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <span onclick="toggleAuthMode('register')">ç«‹å³è¨»å†Š</span>
    </div>
  </div>

  <!-- è¨»å†Šè¡¨å–® (é è¨­éš±è—) -->
  <div id="registerForm" class="card" style="max-width:400px; margin: 40px auto; display:none;">
    <h2 style="text-align:center; margin-bottom:20px; color:#28a745;">æ–°æœƒå“¡è¨»å†Š</h2>
    <p style="font-size:13px; color:#666; margin-bottom:10px;">è¨»å†Šå¾Œå°‡ç‚ºæ‚¨å»ºç«‹å°ˆå±¬å­¸ç¿’æª”æ¡ˆèˆ‡æ­·ç¨‹ç´€éŒ„ã€‚</p>
    <input id="regUser" placeholder="è¨­å®šå¸³è™Ÿ">
    <input id="regPass" type="password" placeholder="è¨­å®šå¯†ç¢¼">
    <button onclick="performRegister()" style="background:#28a745;">ç¢ºèªè¨»å†Š</button>
    <div class="auth-toggle">
        å·²æœ‰å¸³è™Ÿï¼Ÿ <span onclick="toggleAuthMode('login')">è¿”å›ç™»å…¥</span>
    </div>
  </div>
</div>

<!-- 2. å€‹äººå„€è¡¨æ¿ (Dashboard) -->
<div id="account" class="page">
  <div class="card">
    <h2 style="margin-bottom: 20px; border-left: 5px solid #007bff; padding-left: 10px;">å€‹äººå­¸ç¿’æ­·ç¨‹æª”æ¡ˆ</h2>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <p>å­¸å“¡ï¼š<span id="accountName" style="font-weight:bold; font-size: 18px;">è¨ªå®¢</span></p>
        <span style="font-size:12px; color:#888; background:#eee; padding:3px 8px; border-radius:10px;">ID: <span id="accountId">--</span></span>
    </div>
    
    <!-- æ•¸æ“šæ¦‚è¦½ -->
    <div class="stat-grid">
        <div class="stat-box">
            <h4>å·²å®Œæˆå–®å…ƒ</h4>
            <span id="readCount">0</span> ç¯‡
        </div>
        <div class="stat-box">
            <h4>ç¸½å­¸ç¿’æ™‚é–“</h4>
            <span id="totalTime">0</span> åˆ†é˜
        </div>
        <div class="stat-box">
            <h4>ç¤¾ç¾¤è²¢ç»</h4>
            <span id="contributionScore">Lv. 1</span>
        </div>
    </div>

    <!-- é€²åº¦æ¢ -->
    <div class="progress-container">
        <h4 style="color:#444;">æœ¬é€±å­¸ç¿’ç›®æ¨™é”æˆç‡ (<span id="progressText">0</span>%)</h4>
        <div class="progress-bar"><div id="progressBar" class="progress-fill" style="width: 0%;"></div></div>
    </div>

    <!-- å­¸ç¿’æª”æ¡ˆç´€éŒ„ (æ–°å¢åŠŸèƒ½) -->
    <h3 style="font-size: 18px; margin-bottom: 10px; color: #2c3e50;">ğŸ“š å­¸ç¿’æª”æ¡ˆç´€éŒ„ (Portfolio)</h3>
    <div style="overflow-x:auto;">
        <table class="history-table">
            <thead>
                <tr>
                    <th width="50%">å–®å…ƒä¸»é¡Œ</th>
                    <th width="20%">å­¸ç¿’æ—¥æœŸ</th>
                    <th width="30%">å­¸ç¿’æ™‚é•·</th>
                </tr>
            </thead>
            <tbody id="historyList">
                <tr><td colspan="3" style="text-align:center; color:#999;">å°šæœªé–‹å§‹å­¸ç¿’</td></tr>
            </tbody>
        </table>
    </div>

    <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">
    <button onclick="performLogout()" style="background: #dc3545;">ç™»å‡ºç³»çµ±</button>
  </div>
</div>

<!-- 3. ç¤¾ç¾¤èŠå¤©å®¤ (Chatroom) -->
<div id="chatroom" class="page">
    <div class="card">
        <h2 style="margin-bottom: 5px; border-left: 5px solid #28a745; padding-left: 10px;">ç¤¾ç¾¤å³æ™‚èŠå¤©å®¤</h2>
        <p style="font-size: 13px; color: #888; margin-bottom: 15px;">ğŸŸ¢ ç›®å‰æœ‰ 12 ä½å­¸ç¿’è€…èˆ‡è—¥å¸«åœ¨ç·š</p>
        
        <div id="chatBox">
            <div class="chat-msg"><strong>ç³»çµ±æ©Ÿå™¨äººï¼š</strong> æ­¡è¿ä¾†åˆ° Flow Learning è¨è«–å€ï¼è«‹ä¿æŒå‹å–„äº¤æµã€‚</div>
            <div class="chat-msg"><strong>å°æ˜ï¼š</strong> è«‹å•é€™è£¡æœ‰äººä¿®éè—¥ç†å­¸å—ï¼Ÿé—œæ–¼æŠ—ç”Ÿç´ çš„å•é¡Œæƒ³è«‹æ•™ã€‚</div>
            <div class="chat-msg"><strong>è—¥å¸«å°å¹«æ‰‹ï¼š</strong> ä½ å¥½ï¼æˆ‘æ˜¯é§ç«™è—¥å¸«ï¼ŒæŠ—ç”Ÿç´ åˆ‡è¨˜è¦æŒ‰ç™‚ç¨‹æœç”¨å®Œç•¢ï¼Œä¸èƒ½è¦ºå¾—ç—‡ç‹€å¥½äº†å°±åœè—¥å–”ã€‚</div>
            <div class="chat-msg"><strong>å°ç¾ï¼š</strong> åŸä¾†å¦‚æ­¤ï¼Œé•·çŸ¥è­˜äº†ï¼</div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <input id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯åƒèˆ‡è¨è«–..." style="margin-top:0;">
            <button onclick="sendChat()" style="width: 100px; margin-top:0;">ç™¼é€</button>
        </div>
    </div>
</div>

<!-- 4. èª²ç¨‹ç€è¦½ (Explore) -->
<div id="explore" class="page">
  <div id="articleList"></div>
</div>

<!-- 5. å…§å®¹è©³æƒ… (Detail) -->
<div id="detail" class="page">
  <div class="card">
    <button class="secondary" onclick="exitArticle()" style="width:auto; padding: 5px 20px; margin-bottom: 20px;">â† çµæŸé–±è®€ä¸¦è¨˜éŒ„æ™‚é–“</button>
    <h2 id="detailTitle" style="color: #007bff; margin-bottom: 15px; font-size: 24px;"></h2>
    <div style="height: 4px; width: 50px; background: #007bff; margin-bottom: 20px;"></div>
    <p id="detailContent" style="line-height:1.8; color: #444; font-size: 17px; white-space: pre-line;"></p>
  </div>

  <div class="card">
    <h3>å…±å‰µç•™è¨€æ¿</h3>
    <p style="color:#888; font-size:13px; margin-bottom:15px;">æ‚¨çš„è¦‹è§£å°‡æˆç‚ºç¤¾ç¾¤çŸ¥è­˜çš„ä¸€éƒ¨åˆ†</p>
    <div id="detailComments"></div>
    <input id="commentInput" placeholder="åˆ†äº«ä½ çš„çœ‹æ³•..." onkeydown="addComment(event)">
  </div>
</div>

<script>
/* æ ¸å¿ƒç³»çµ±é‚è¼¯ 
   åŒ…å«ï¼šæ¨¡æ“¬è³‡æ–™åº«(LocalStorage)ã€å­¸ç¿’è¨ˆæ™‚å™¨ã€æœƒå“¡é©—è­‰
*/

// å…¨åŸŸè®Šæ•¸
let currentUserData = null; // ç•¶å‰ç™»å…¥çš„ä½¿ç”¨è€…å®Œæ•´è³‡æ–™ç‰©ä»¶
let currentArticle = null;
let learningTimer = null;   // è¨ˆæ™‚å™¨
let sessionStartTime = 0;   // æœ¬æ¬¡é–±è®€é–‹å§‹æ™‚é–“

/* æ¨¡æ“¬æ–‡ç« è³‡æ–™åº« */
const articles = [
  { 
    id: 1, 
    title: "æ„Ÿå†’æ­£ç¢ºç”¨è—¥çŸ¥å¤šå°‘", 
    content: "ã€æ ¸å¿ƒè§€å¿µã€‘\né£Ÿå“è—¥ç‰©ç®¡ç†ç½²(ç°¡ç¨±:é£Ÿè—¥ç½²)æé†’æ°‘çœ¾ï¼Œå¸‚é¢ä¸Šä¹‹ç¶œåˆæ„Ÿå†’è—¥å«æœ‰å¤šç¨®æˆåˆ†ï¼Œå¯èƒ½æœ‰æ­¢ç—›é€€ç‡’ã€æŠ—çµ„ç¹”èƒºç­‰ã€‚ä½†ç¶œåˆæ„Ÿå†’è—¥åªèƒ½ç·©è§£ç—‡ç‹€ï¼Œä¸èƒ½é é˜²æ„Ÿå†’ã€‚\n\nã€é‡è¦æé†’ã€‘\n1. æˆäººåœ¨å……åˆ†ä¼‘æ¯ã€è£œå……æ°´åˆ†å¾Œï¼Œå¤§å¤šæœƒåœ¨ä¸€åˆ°äºŒå€‹ç¦®æ‹œå…§è‡ªè¡Œç—Šç™’ã€‚\n2. æ°‘çœ¾ä¸å¯è‡ªè¡Œå¢åŠ ç¶œåˆæ„Ÿå†’è—¥åŠ‘é‡æˆ–æ˜¯ä½µç”¨å¤šç¨®æ„Ÿå†’è—¥ï¼Œåè€Œå¯èƒ½æœƒå¢åŠ å‰¯ä½œç”¨ã€‚\n3. é€£çºŒå‡æ—¥é–‹è»Šæ™‚ï¼Œæ‡‰æ³¨æ„éƒ¨åˆ†ç¶œåˆæ„Ÿå†’è—¥æœƒé€ æˆå—œç¡ã€‚\n\n(è³‡æ–™ä¾†æºï¼šè¡›ç¦éƒ¨é£Ÿè—¥ç½²)", 
    comments: ["æˆ‘è¦ºå¾—å¤šå–æ°´æœ€é‡è¦ï¼Œè—¥åªæ˜¯è¼”åŠ©ã€‚", "é•·è¼©å¸¸å¸¸ä»¥ç‚ºåƒå¤šä¸€é»å¥½å¾—å¿«ï¼ŒçœŸçš„è¦å®£å°ï¼"] 
  },
  { 
    id: 2, 
    title: "å¿ƒè¡€ç®¡ç”¨è—¥æ³¨æ„äº‹é …", 
    content: "ã€å¸¸è¦‹è—¥ç‰©åˆ†é¡ã€‘\nå¿ƒè¡€ç®¡ç–¾ç—…æ‚£è€…é™¤äº†æ³¨é‡æ—¥å¸¸ä¿é¤Šï¼Œé‚„éœ€ç¶“ç”±é†«å¸«è¨ºæ–·ï¼Œçµ¦äºˆé é˜²èˆ‡æ²»ç™‚çš„ç›¸é—œè—¥ç‰©ã€‚\n\n1. æŠ—å¿ƒçµç—›è—¥ç‰©ï¼šä¸»è¦ç”¨æ–¼å¿ƒçµç—›çš„æ²»ç™‚åŠé é˜²ï¼Œé¬†å¼›å¿ƒè‡Ÿè¡€ç®¡ã€‚\n2. éˆ£é›¢å­ç®¡é“é˜»æ–·åŠ‘ï¼šæ“´å¼µå† ç‹€å‹•è„ˆã€å‘¨é‚Šå‹•è„ˆã€‚\n\nã€æœç”¨é ˆçŸ¥ã€‘\næœè—¥æœŸé–“æ‡‰é¿å…é£Ÿç”¨è‘¡è„æŸšåŠå…¶ç›¸é—œé£Ÿå“ï¼Œä»¥å…ç™¼ç”Ÿäº¤äº’ä½œç”¨ã€‚è‹¥æœ‰çœ©æšˆã€å—œç¡æƒ…æ³ï¼Œè¦é¿å…é–‹è»Šã€‚", 
    comments: ["è‘¡è„æŸšçœŸçš„å¾ˆå®¹æ˜“è¢«å¿½ç•¥ï¼Œè¦æ³¨æ„ï¼"] 
  },
  { 
    id: 3, 
    title: "æŠ—ç”Ÿç´ ä½¿ç”¨çš„äº”å¤§è¿·æ€", 
    content: "ã€è¿·æ€ä¸€ï¼šç—‡ç‹€å¥½äº†å°±å¯ä»¥åœè—¥ï¼Ÿã€‘\néŒ¯ï¼æŠ—ç”Ÿç´ å¿…é ˆæŒ‰ç…§é†«å¸«æŒ‡ç¤ºçš„ç™‚ç¨‹åƒå®Œï¼Œå¦å‰‡ç´°èŒå®¹æ˜“ç”¢ç”ŸæŠ—è—¥æ€§ï¼Œä¸‹æ¬¡å†ç”Ÿç—…å°±æ›´é›£æ²»ç™‚äº†ã€‚\n\nã€è¿·æ€äºŒï¼šæŠ—ç”Ÿç´ å°±æ˜¯æ¶ˆç‚è—¥ï¼Ÿã€‘\né€™ä¹Ÿæ˜¯å¸¸è¦‹èª¤è§£ã€‚æŠ—ç”Ÿç´ æ˜¯æ®ºç´°èŒçš„ï¼Œæ¶ˆç‚è—¥æ˜¯æŠ—ç™¼ç‚çš„ï¼Œå…©è€…æ©Ÿåˆ¶å®Œå…¨ä¸åŒã€‚", 
    comments: ["çœŸçš„å¾ˆå¤šäººæœƒäº‚åœè—¥ï¼Œä»¥ç‚ºå¥½äº†å°±ä¸åƒã€‚", "åŸä¾†æ¶ˆç‚è—¥è·ŸæŠ—ç”Ÿç´ ä¸ä¸€æ¨£ï¼"] 
  }
];

/* --- è³‡æ–™åº«èˆ‡æœƒå“¡ç³»çµ± (LocalStorage) --- */

// å¾ LocalStorage å–å¾—æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™ï¼Œè‹¥ç„¡å‰‡åˆå§‹åŒ–
function getUsersDB() {
    const db = localStorage.getItem('flowLearningDB');
    return db ? JSON.parse(db) : {};
}

// å„²å­˜ä½¿ç”¨è€…è³‡æ–™å› LocalStorage
function saveUsersDB(db) {
    localStorage.setItem('flowLearningDB', JSON.stringify(db));
}

// è¨»å†ŠåŠŸèƒ½
function performRegister() {
    const user = document.getElementById("regUser").value.trim();
    const pass = document.getElementById("regPass").value.trim();

    if (!user || !pass) {
        alert("è«‹è¼¸å…¥å®Œæ•´çš„å¸³è™Ÿèˆ‡å¯†ç¢¼ï¼");
        return;
    }

    const db = getUsersDB();
    if (db[user]) {
        alert("æ­¤å¸³è™Ÿå·²è¢«è¨»å†Šï¼Œè«‹æ›´æ›å¸³è™Ÿæˆ–ç›´æ¥ç™»å…¥ã€‚");
        return;
    }

    // å»ºç«‹æ–°ä½¿ç”¨è€…çµæ§‹
    db[user] = {
        password: pass,
        registerDate: new Date().toLocaleDateString(),
        learningHistory: [], // å­¸ç¿’æª”æ¡ˆï¼šç´€éŒ„çœ‹éçš„æ–‡ç« 
        totalLearningSeconds: 0, // ç¸½å­¸ç¿’ç§’æ•¸
        contributionLevel: 1
    };
    
    saveUsersDB(db);
    alert("è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¸³è™Ÿç™»å…¥ã€‚");
    toggleAuthMode('login');
}

// ç™»å…¥åŠŸèƒ½
function performLogin() {
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    
    const db = getUsersDB();

    // ç°¡å–®çš„é©—è­‰é‚è¼¯
    if (db[user] && db[user].password === pass) {
        currentUserData = { ...db[user], username: user }; // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™åˆ°è¨˜æ†¶é«”
        updateUserUI();
        showPage("explore");
    } else {
        alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚(è‹¥ç„¡å¸³è™Ÿè«‹å…ˆè¨»å†Š)");
    }
}

// ç™»å‡ºåŠŸèƒ½
function performLogout() {
    currentUserData = null;
    document.getElementById("loginUser").value = "";
    document.getElementById("loginPass").value = "";
    document.getElementById("userStatus").innerText = "";
    showPage("login");
}

/* --- é é¢èˆ‡ UI é‚è¼¯ --- */

function showPage(id){
  // è‹¥æœªç™»å…¥ä¸”å˜—è©¦è¨ªå•éç™»å…¥é ï¼Œå¼·åˆ¶è·³å›ç™»å…¥
  if (!currentUserData && id !== 'login') {
      alert("è«‹å…ˆç™»å…¥æœƒå“¡ä»¥å­˜å–å­¸ç¿’å…§å®¹ï¼");
      showPage('login');
      return;
  }

  // åˆ‡æ›é é¢é¡¯ç¤º
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
  
  if(id==="explore") renderArticles();
  if(id==="account") renderAccount();
  if(id==="chatroom") scrollToBottom();
  
  window.scrollTo(0,0);
}

// åˆ‡æ›ç™»å…¥/è¨»å†Šæ¨¡å¼
function toggleAuthMode(mode) {
    document.getElementById("loginForm").style.display = mode === 'login' ? 'block' : 'none';
    document.getElementById("registerForm").style.display = mode === 'register' ? 'block' : 'none';
}

// æ›´æ–° Header ä½¿ç”¨è€…ç‹€æ…‹
function updateUserUI() {
    if (currentUserData) {
        document.getElementById("userStatus").innerText = `æ­¡è¿å›ä¾†, ${currentUserData.username}`;
    }
}

/* --- å­¸ç¿’è¨ˆæ™‚èˆ‡å…§å®¹é‚è¼¯ --- */

// é–‹å•Ÿæ–‡ç«  (é–‹å§‹è¨ˆæ™‚)
function openArticle(id){
  currentArticle = articles.find(a=>a.id===id);
  document.getElementById("detailTitle").innerText = currentArticle.title;
  document.getElementById("detailContent").innerText = currentArticle.content;
  
  renderComments();
  showPage("detail");

  // é–‹å§‹å­¸ç¿’è¨ˆæ™‚
  sessionStartTime = Date.now();
  console.log("é–‹å§‹å­¸ç¿’è¨ˆæ™‚...");
}

// é›¢é–‹æ–‡ç«  (çµç®—æ™‚é–“ä¸¦å­˜æª”)
function exitArticle() {
    if (sessionStartTime > 0 && currentUserData) {
        const endTime = Date.now();
        const durationSeconds = Math.floor((endTime - sessionStartTime) / 1000); // è¨ˆç®—ç§’æ•¸
        
        // 1. æ›´æ–°ç¸½æ™‚æ•¸
        currentUserData.totalLearningSeconds += durationSeconds;
        
        // 2. æ›´æ–°å­¸ç¿’æª”æ¡ˆ (History)
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰é€™ç¯‡çš„ç´€éŒ„ï¼Œå¦‚æœæœ‰å°±æ›´æ–°æ™‚é–“ï¼Œæ²’æœ‰å°±æ–°å¢
        const existingRecord = currentUserData.learningHistory.find(h => h.articleId === currentArticle.id);
        
        const nowStr = new Date().toLocaleString();

        if (existingRecord) {
            existingRecord.lastAccess = nowStr;
            existingRecord.timeSpentSeconds += durationSeconds;
        } else {
            currentUserData.learningHistory.unshift({
                articleId: currentArticle.id,
                title: currentArticle.title,
                lastAccess: nowStr,
                timeSpentSeconds: durationSeconds
            });
        }

        // 3. å¯«å›è³‡æ–™åº« (LocalStorage)
        const db = getUsersDB();
        // æ›´æ–°è©²ä½¿ç”¨è€…çš„è³‡æ–™ (ç§»é™¤ username æ¬„ä½å› ç‚ºé‚£æ˜¯ key)
        const { username, ...dataToSave } = currentUserData; 
        db[username] = dataToSave;
        saveUsersDB(db);
        
        console.log(`å­¸ç¿’çµæŸï¼Œæœ¬æ¬¡æŒçºŒ ${durationSeconds} ç§’`);
    }

    sessionStartTime = 0; // é‡ç½®
    showPage('explore'); // è¿”å›åˆ—è¡¨
}

/* --- å„€è¡¨æ¿æ¸²æŸ“ (Dashboard) --- */

function renderAccount(){
    if (!currentUserData) return;

    document.getElementById("accountName").innerText = currentUserData.username;
    document.getElementById("accountId").innerText = currentUserData.registerDate || "N/A";
    
    const history = currentUserData.learningHistory || [];
    const totalSec = currentUserData.totalLearningSeconds || 0;

    // æ•¸æ“šæ¦‚è¦½
    document.getElementById("readCount").innerText = history.length;
    document.getElementById("totalTime").innerText = Math.floor(totalSec / 60); // é¡¯ç¤ºåˆ†é˜
    document.getElementById("contributionScore").innerText = `Lv. ${currentUserData.contributionLevel}`;

    // é€²åº¦æ¢ (å‡è¨­ç›®æ¨™æ˜¯é–±è®€ 5 ç¯‡)
    const progress = Math.min(100, Math.floor((history.length / 5) * 100));
    document.getElementById("progressBar").style.width = `${progress}%`;
    document.getElementById("progressText").innerText = progress;

    // æ¸²æŸ“å­¸ç¿’æª”æ¡ˆè¡¨æ ¼
    const historyBody = document.getElementById("historyList");
    if(history.length > 0){
        historyBody.innerHTML = history.map(item => {
            const mins = Math.floor(item.timeSpentSeconds / 60);
            const secs = item.timeSpentSeconds % 60;
            const timeStr = mins > 0 ? `${mins}åˆ†${secs}ç§’` : `${secs}ç§’`;
            
            return `
            <tr>
                <td><strong>${item.title}</strong></td>
                <td style="font-size:12px;">${item.lastAccess.split(' ')[0]}</td>
                <td><span style="color:#28a745; font-weight:bold;">${timeStr}</span></td>
            </tr>`;
        }).join("");
    } else {
        historyBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">å°šæœªé–‹å§‹å­¸ç¿’ï¼Œå¿«å»ç€è¦½èª²ç¨‹å§ï¼</td></tr>';
    }
}

/* --- æ¸²æŸ“æ–‡ç« åˆ—è¡¨ --- */
function renderArticles(){
  const list = document.getElementById("articleList");
  list.innerHTML="";
  articles.forEach(a=>{
    const div=document.createElement("div");
    div.className="card article-item";
    div.innerHTML=`
        <h3>${a.title}</h3>
        <p class="article-desc">${a.content.substring(0,60).replace(/\n/g, ' ')}...</p>
        <div style="text-align:right; font-size:13px; color:#007bff;">é»æ“Šé–‹å§‹å­¸ç¿’ â†’</div>
    `;
    div.onclick = () => openArticle(a.id); 
    list.appendChild(div);
  });
}

/* --- ç•™è¨€èˆ‡èŠå¤© --- */
function renderComments(){
  const box=document.getElementById("detailComments");
  box.innerHTML= currentArticle.comments.map((c,i)=>
    `<div class="comment"><strong>${i+1}æ¨“:</strong> ${c}</div>`
  ).join("");
}

function addComment(e){
  if(e.key==="Enter" && e.target.value){
    currentArticle.comments.push(`${currentUserData.username}ï¼š${e.target.value}`);
    e.target.value="";
    renderComments();
    
    // å¢åŠ è²¢ç»åº¦ (ç°¡å–®æ¨¡æ“¬)
    currentUserData.contributionLevel += 1;
  }
}

function sendChat(){
    const input = document.getElementById("chatInput");
    if(input.value){
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML += `<div class="chat-msg my-msg"><strong>${currentUserData.username}:</strong> ${input.value}</div>`;
        input.value = "";
        scrollToBottom();
        setTimeout(() => {
             chatBox.innerHTML += `<div class="chat-msg"><strong>ç³»çµ±æ©Ÿå™¨äººï¼š</strong> æ”¶åˆ°æ‚¨çš„è¨Šæ¯ï¼</div>`;
             scrollToBottom();
        }, 1500);
    }
}

function scrollToBottom(){
    const chatBox = document.getElementById("chatBox");
    chatBox.scrollTop = chatBox.scrollHeight;
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
showPage("login"); 
</script>

</body>
</html>
